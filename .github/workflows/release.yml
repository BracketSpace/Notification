name: Release new version

on: repository_dispatch

jobs:
  release:
    if: github.event.action == 'release'
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: develop
      - name: Fetch master branch
        run: |
          git fetch origin master
      - name: Install git-flow
        run: |
          sudo apt-get install git-flow -y
      - name: Configure commiter
        run: |
          git config --local user.email "buddy@bracketspace.com"
          git config --local user.name "BracketSpace Worker"
      - name: Start release
        run: |
          git flow init -d
          git flow release start ${{ github.event.client_payload.new_version }}
      - name: Replace [Next] tags with new version number
        uses: jacobtomlinson/gha-find-replace@0.1.1
        with:
          find: "[Next]"
          replace: "${{ github.event.client_payload.new_version }}"
      - name: Replace stable tag in readme
        uses: jacobtomlinson/gha-find-replace@0.1.1
        with:
          find: "Stable tag: [0-9]+.[0-9]+.[0-9]+"
          replace: "Stable tag: ${{ github.event.client_payload.new_version }}"
          include: "/readme.txt"
      - name: Commit version bump
        run: |
          git commit -am "Version bump"
      - name: Finish release
        run: |
          git flow release finish ${{ github.event.client_payload.new_version }}
      - name: Test branches
        run: |
          git status
          git branch --list
          git checkout master
          git status
